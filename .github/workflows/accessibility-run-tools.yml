name: Accessibility All Repos Test (Only AXE)

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/accessibility-run-tools.yml
      - run-tests.js

jobs:
  run-tests:
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout workflow repo
        uses: actions/checkout@v4

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git unzip curl \
            python3 python3-pip \
            php composer \
            openjdk-17-jdk maven gradle \
            libnss3 libnspr4 libatk1.0-0 libatk-bridge2.0-0 libcups2 libdrm2 \
            libxkbcommon0 libxcomposite1 libxdamage1 libxfixes3 libxrandr2 libgbm1 \
            libasound2 libpangocairo-1.0-0 libpango-1.0-0 libgtk-3-0 \
            libx11-xcb1 libxrender1 libxcursor1 libxi6 libxtst6 libxss1 libxshmfence1

      - name: Install Node.js 18
        run: |
          curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
          sudo apt-get install -y nodejs
          node -v
          npm -v

      - name: Install Node.js dependencies
        run: |
          npm install axe-core puppeteer node-fetch@2 csv-writer

      - name: Run accessibility tests
        env:
          TOKEN_1: ${{ secrets.TOKEN_1 }}
          TOKEN_2: ${{ secrets.TOKEN_2 }}
          TOKEN_3: ${{ secrets.TOKEN_3 }}
        run: |
          node run-tests.js

      - name: Upload CSV results
        uses: actions/upload-artifact@v4
        with:
          name: accessibility-results
          path: resultados_acessibilidade.csv
